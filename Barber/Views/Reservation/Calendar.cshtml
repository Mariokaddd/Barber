@model Barber.Models.CalendarViewModel

@{
    ViewData["Title"] = "Календар за резервации";
    var ms = Model.MonthStart;
    var prevMonth = ms.AddMonths(-1);
    var nextMonth = ms.AddMonths(1);
    DateTime today = DateTime.Today;
    var ajaxUrl = Url.Action("SlotsAjax", "Reservation");
}

<h1 class="text-center mb-4">@ViewData["Title"]</h1>

<div class="d-flex justify-content-between align-items-center mb-3">
    @if (prevMonth >= new DateTime(today.Year, today.Month, 1))
    {
        <a asp-action="Calendar"
           asp-route-year="@prevMonth.Year"
           asp-route-month="@prevMonth.Month"
           class="btn btn-sm btn-outline-secondary">←</a>
    }
    else
    {
        <button class="btn btn-sm btn-outline-secondary" disabled>←</button>
    }

    <h4 class="mx-3">@ms.ToString("MMMM yyyy", new System.Globalization.CultureInfo("bg-BG"))</h4>

    <a asp-action="Calendar"
       asp-route-year="@nextMonth.Year"
       asp-route-month="@nextMonth.Month"
       class="btn btn-sm btn-outline-secondary">→</a>
</div>

<div id="calendarGrid" class="calendar-grid">
    @foreach (var day in Model.Days)
    {
        bool past = day.Date < today;
        string css = past ? "calendar-day disabled" : "calendar-day";
        <button type="button"
                class="@css"
                data-date="@day.Date.ToString("yyyy-MM-dd")"
                @(past ? "disabled" : "")>
            <div class="day-number">@day.Date.Day</div>
            @if (day.FreeSlotCount > 0 && !past)
            {
                <span class="badge bg-primary">@day.FreeSlotCount</span>
            }
        </button>
    }
</div>

<hr />

<div id="slotsContainer" class="mt-4 text-center">
    <p class="text-muted">Кликни върху дата, за да видиш свободните часове</p>
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const grid = document.getElementById("calendarGrid");
            const slotsContainer = document.getElementById("slotsContainer");
            const ajaxUrl = '@ajaxUrl';

            grid.addEventListener("pointerdown", async e => {
                const btn = e.target.closest("button.calendar-day");
                if (!btn || btn.disabled) return;

                // премахваме селекция от всички дни
                grid.querySelectorAll("button.calendar-day")
                    .forEach(d => d.classList.remove("selected"));
                // маркираме натиснатия
                btn.classList.add("selected");

                const date = btn.dataset.date;
                try {
                    const res = await fetch(`${ajaxUrl}?date=${date}`);
                    if (!res.ok) {
                        const text = await res.text();
                        throw text || res.statusText;
                    }
                    slotsContainer.innerHTML = await res.text();
                } catch (err) {
                    slotsContainer.innerHTML = `<p class="text-danger">Грешка при зареждане: ${err}</p>`;
                }
            });
        });
    </script>
}

<style>
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 8px;
    }

    .calendar-day {
        padding: 8px;
        border-radius: 6px;
        text-align: center;
        border: none;
        background: #f8f9fa;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }

        .calendar-day:hover:not(.disabled) {
            background-color: #e2f0ff;
            transform: translateY(-2px);
        }

        .calendar-day.selected {
            background-color: #007bff;
            color: white;
        }

        .calendar-day.disabled {
            background-color: #f1f1f1;
            color: #bbb;
            cursor: default;
            opacity: 0.6;
            pointer-events: none;
        }

    .day-number {
        font-size: 1.2rem;
    }

    .badge {
        background: #007bff;
        color: white;
        border-radius: 12px;
        padding: 2px 8px;
        font-size: 0.8rem;
        margin-top: 4px;
        display: inline-block;
    }
</style>
